{-# LANGUAGE BangPatterns, RankNTypes, GeneralizedNewtypeDeriving, ScopedTypeVariables #-}
{-# LANGUAGE TupleSections #-}
module ECC.Code.LDPC.Reference where

-- Reference implementation of LDPC

import Data.Bit
import ECC.Types
import ECC.Puncture
import Data.Char (isDigit)
import Data.Matrix
import qualified Data.Vector as V
import Data.Alist

import Debug.Trace

type M a = Matrix a
type V a = V.Vector a

code :: Code
code = Code ["ldpc/reference/<matrix-name>/<max-rounds>[/<truncation-size>]"]
     $ \ xs -> case xs of
                ["ldpc","reference",m,n]
                        | all isDigit n -> fmap (: []) $ mkLDPC m (read n) False
                ["ldpc","debug",m,n]
                        | all isDigit n -> fmap (: []) $ mkLDPC m (read n) True
                ["ldpc","reference",m,n,t]
                        | all isDigit n
                       && all isDigit t -> fmap (: []) $ fmap (punctureTail (read t)) $ mkLDPC m (read n) False
                _                       -> return []

punctureTail :: Int -> ECC -> ECC
punctureTail n ecc = punctureECC (<= (codeword_length ecc - n)) ecc


mkLDPC :: String -> Int -> Bool -> IO ECC
mkLDPC codeName maxI debugging = do
   g :: G <- readAlist ("codes/" ++ codeName ++ ".G")   -- with G, we prepend the identity
   let full_g = identity (nrows g) <|> g
   h :: H <- readAlist ("codes/" ++ codeName ++ ".H")
   return $ ECC
        { name     = "ldpc/reference/" ++ codeName ++ "/" ++ show maxI
        , encode   = return . V.toList . encoder full_g . V.fromList
        , decode   = if debugging
                     then \ inp -> do
                             res <- debug_ldpc maxI h (V.fromList inp)
                             return $ (,True) $  take (nrows full_g) $ V.toList res
                     else return . (,True) . take (nrows full_g) . V.toList . ldpc maxI h . V.fromList
        , message_length  = nrows full_g
        , codeword_length =  ncols full_g
        }

type G = M Bit
type H = M Bit

encoder :: G -> V Bit -> V Bit
encoder g v = getRow 1 (multStd (rowVector v) g)

---------------------------------------------------------------------

ldpc :: Int -> M Bit -> V Double -> V Bit
ldpc maxIterations a orig_lam = fmap hard $ loop 0 orig_ne orig_lam
  where
    orig_ne :: M Double
    orig_ne = fmap (const 0) a

    loop :: Int -> M Double -> V Double -> V Double
    loop !n ne lam
        | V.all (== 0) ans             = lam
        | n >= maxIterations           = orig_lam
        | otherwise                    = loop (n+1) ne' lam'
      where
        c_hat :: V Bit
        c_hat = fmap hard lam

        -- was bug here: needed to getCol, not getRow (which was a single element)
        ans :: V Bit
        ans = getCol 1 (a `multStd` colVector c_hat)

        -- was bug here: V's start at index 0, not 1
        ne' :: M Double
        ne' = matrix (nrows orig_ne) (ncols orig_ne) $ \ (m,n) ->
                if a ! (m,n) == 1
                then
                   -- was bug here: we need to cap atanh's answer
                    -2 * atanh' (product
                        [ tanh (- ((lam V.! (j-1) - ne ! (m,j)) / 2))
                        | j <- [1 .. V.length orig_lam]
                        , j /= n
                        , a ! (m,j) == 1
                        ])
                else 0

        -- Was bug here: needed to add the orig_lam
        lam' :: V Double
        lam' = V.fromList [ V.foldr (+) (orig_lam V.! (j - 1)) (getCol j ne')
                          | j <- [1 .. V.length lam]
                          ]


lam0 = [13.320417035342127,1.7705637956184823,-12.908378137315083,-19.488877748622293,-14.261983988852908,12.732836685137375,-6.679248277073296,-12.774587091887659,-9.856502152238937,16.075345958471235,4.665350402418143,12.917000122696944,16.383888661399833,12.161320319899767,13.39101616572441,-7.251691698918567,9.845717077073946,-6.782005006846396,-3.72971539018692,-19.9384047946914,-7.73498811329568,18.26220348613898,11.122622711153706,-11.556816032219931,14.20941139593421,-1.1466960473938839,12.277833442564026,-10.979161618562012,-6.934191836586478,-8.417867647219923,-21.763494164205003,-6.627353606840662,8.300080055226575,-23.217398116772085,-14.877733743500547,13.55591594009035,9.175996253966229,-1.580516722601106,-3.7532385316400902,9.613581016755752,4.890476598507158,-17.786950621939287,9.93426878996141,-6.412143372577075,19.701163631187615,-15.081003465181608,15.485214588766372,15.795945258016465,-4.983751715533777,12.26692918746389,17.394946750273277,-16.743181546841214,-10.038103860308588,3.9399449874194654,-11.308078090374321,16.62235680123335,9.795034628319208,-8.602242707031834,-12.890180659951755,9.283349812894755,11.68013105344561,-2.136889923607824,13.40145521556449,-7.869434456837355,16.21263313176705,10.986721729805344,13.545568336321223,21.467314264157288,-1.2190660857641338,-8.887147353258818,-10.5670226670934,5.081058536482688,-11.119882075108539,4.603031350022508,15.846389998031727,8.108096654860198,15.785520121243856,-8.048742057011298,9.483762837370527,3.909362855875422,-8.83343316360663,4.756163731548556,-12.639209118995323,-18.201535026216,13.231910631489766,14.734923056383645,12.350244917027792,13.264156990495337,7.463992507563194,17.702749834100818,0.8313691170131606,15.531624255510705,-7.400326258021855,15.58728194890447,-12.76788080912939,-16.30992186099683,-9.09509714256899,-5.526645712830794,-9.067527099263739,8.217003057182799,-15.236848408817293,-5.36796402508109,22.453940103354306,-15.948431432679385,13.454022165347679,-11.931303714191085,-11.9894590305193,11.48525220698313,-9.473287280230378,-8.92353082373961,-14.84673914628957,17.729252576342056,10.86320334517842,10.058987262578801,16.2084995207422,22.019291056474145,-21.895029936818,9.131766727009012,16.310374083619227,-20.384160278762142,7.320393963176964,1.530609241307293,15.908145787427895,-11.901542389002467,12.796235963377322,-11.271496091975699,-13.081648744411421,-9.799251128883203,17.204943224147655,-8.040157494098343,13.33654678846945,9.60623005408958,-15.812020840766593,10.281948081682343,-14.731520007482708,-14.102071673775367,-8.83593568195482,17.447524225122635,-4.043191463565015,-10.285318037599442,-13.107810987826342,14.282214950127106,5.379865958686817,21.989720459957937,-18.17379617274146,-11.660823426919064,-9.560878678827029,7.4408468276022015,-7.759565412012501,-10.964310566652735,-12.924611301747543,-11.34814661631044,6.290619254160166,5.084195761048065,15.998766344416289,13.580791158716561,-13.104623125765277,-5.240719941565982,-3.8981931965691268,-14.414967140842048,11.296196511815547,-13.552556657905864,0.2643265711222298,6.725215304310348,-1.0126319583785974,-6.5785791857374445,15.458926394477386,-9.004350129149875,-12.608757861296828,-4.659282784594331,-21.943309054812435,-13.717310606031624,-8.705355900838683,-12.149836444686969,-14.597906156769843,-0.821249621151926,-19.297999400526447,4.440865522302313,5.447997547653604,-14.740060602288112,19.7974184932936,-6.397852922959566,7.3187491632757,12.951056641235477,14.83125849535951,-13.833684098781935,9.18013157249467,-12.959294914068863,8.72980669595008,11.848798620580885,-11.312133522166201,5.8395454904968505,16.915447616549987,-15.466004040004046,-11.665254528060224,5.535863018877148,12.01821757548191,8.444460000574765,-10.084511355348281,-21.669480078865135,-12.491874655918012,-12.385206974929545,-17.365590808546337,9.004272876411562,10.415019498281127,-11.240555312207846,-20.369247105588073,10.09605493178212,13.33502073146983,10.63997099380883,-11.449272199170796,11.48400471819478,11.2976417071652,14.300429435487104,-15.543403532984328,-15.9778792017786,-11.049441299336053,18.304539035189016,5.760522947497536,13.995499549459774,16.431877910393254,12.028177222813644,7.513903326895625,-17.28802496946144,-8.042114337462557,-13.024829174783342,23.784202455436244,19.818419395415468,14.623622483989651,-8.604128165389618,10.879535797216139,14.022997473194529,-9.887809589674546,9.299876079614982,-5.473580231006364,7.166099029815653,18.0502110709788,12.818031270211254,-16.415369769197923,-4.30674370013593,1.8323840096631665,-12.748068167310894,-4.076090711618214,10.346413485064208,15.155877084882398,5.465072318396528,-9.993343479512001,5.792015880382997,-18.98647784591424,-5.792674446419178,-8.122208678176154,8.308898368979301,14.61796971308489,8.062875381782217,-7.139400506231605,-7.331712407039192,-14.86550626569525,10.768952847079662,15.62612318481826,11.239591333561762,6.416695245058602,9.953622761253833,-15.607351582907508,-8.920981128857917,-10.19106931206052,15.786837116088542,7.680861967407352,10.522089465365411,-16.387095384952904,16.561895805637615,11.70019931226771,-3.660718372863824,13.311299734526878,-4.982762962971797,-14.431242881051718,14.773189921003182,20.587990233023955,6.265189589860835,20.91402239423088,-17.082260746775354,8.550693493534613,9.863017432722499,-17.102944567541385,-9.522090361236884,-15.279841932026299,15.92240428600516,4.738679611771599,5.322839702807579,12.633886966603844,-7.545577244306837,-8.84329673182076,8.908275417323901,-12.483144482561041,-4.617219741850947,-15.248628832001485,12.079091936132976,21.451822423429498,-13.216413095309052,8.076261423671923,11.131546435019809,2.682226801619799,16.973017839830316,5.176807297846987,-14.719814556323875,-18.584383542917447,-8.795481555949705,-15.641425120923431,-15.863438536513248,15.575324340626725,10.320247379560284,-11.794088495552025,-12.063768351801853,-9.915793173075356,-15.382377332266069,7.816668551354118,15.167314610265189,-11.134285778925948,15.37781360227057,9.781565740647949,-8.791839281805688,-16.440193604475255,-11.834203914507423,-14.297541829207187,3.627625549138347,-10.847384511586455,15.062259337072001,-16.809932146616678,15.553433660838499,12.623025177775501,-3.4426640265273774,-5.591317259243069,-13.47354396031915,14.107118300922743,4.066646971722878,-14.827615399861367,10.450081010132536,6.077074973399927,11.456320754550653,-10.998988242902787,17.314827120347932,12.081354608978163,-15.31599327629013,-16.449409741192955,3.465056770810954,2.089168971824729,8.477697390967911,-14.166120559972397,13.272813796765666,-8.451106006736886,11.227541699503051,-10.859961732927076,-14.369262435201247,8.160324243838847,14.442629408187642,-17.09071494089328,-22.246211170094686,-2.20369078483434,22.095985353542616,18.032299564381628,-9.851933980238849,11.901098671020668,13.570652808789012,-13.389991856263936,5.722230230155301,19.706669784620747,11.112899307412105,-11.443793112992344,8.881852625596387,-4.602677449085072,6.369039447875829,-9.4232713883645,-9.660849563113176,-12.893867600759027,-11.520939857990756,13.447534917943631,-6.672524369017968,10.756260406564202,3.6447492469326477,7.765779795689766,-11.21297552810348,15.96058220020882,10.77915829495099,-7.982093267835461,-13.871885811523988,4.895667743832118,15.093868817468792,6.737269494350251,10.272989244496014,10.836143632948334,4.432635744176146,16.177129153233704,12.864937080082887,14.12226035975737,11.106165957627839,3.796336495149165,17.815406963698283,7.132080070976439,12.152293074481904,10.895016486629052,-14.096914517922311,8.689326764045795,13.84306762514216,9.77718093662013,6.99406164969854,-12.822118441816095,6.171747632843472,20.883227522094,18.369258782919825,-13.677822973716575,13.869175495007172,-6.972749796662283,16.988016450461004,-8.390630794227691,-10.25300415871409,-20.681219813754105,17.538416441893602,4.944774574979444,7.846020869164755,-2.522096559883341,-5.696008316614092,1.1334809952648457,-16.525732033292886,4.5566862917463515,18.10768122466596,10.734930626391623,3.949474279565445,-13.35544636530599,-14.991467859289154,-11.75791566459253,-14.980563463991043,11.253572961937827,-9.737320895932339,-7.726741429225446,-7.88689796365086,9.631938418013094,11.276021508280596,12.530395076478682,-17.94456533627684,22.430395392539417,-17.900483390114527,-9.490501452019481,11.607081631568008,-8.918629283263918,-15.338277573235695,13.032594453693875,8.961021979633824,-10.309664122197102,11.28649372580649,6.3585289356194075,-7.716582330315937,-11.790668670967914,-8.864786254619665,7.698005156921409,-15.056333888096427,1.713312855223438,-11.34265566338241,5.6839467974345075,-6.874163503200517,3.8174816355376606,6.765506229694264,18.94354917580211,10.166502150974607,-8.656251916286811,4.070173331223559,8.214427987157725,-7.193511513337799,7.785490904357077,12.594464574223442,-9.850285521552044,7.6857945354283235,-17.444798042856448,15.237987635076921,-12.348951829501207,15.944010423241005,8.363309139812356,11.258501629494818,-13.649519224751739,-12.399193522219656,-9.806347386482003,-4.047264783457223,-11.029545103718606,-5.303768434059855,-6.874066774353466,-0.8789091554215607,-14.465202326578169,-10.409082035832881,-11.6362649576474,-10.185200487797074,12.86157354207003,16.203130980804314,-16.954492332039763,-17.90980251970942,12.608464206742234,-3.138425437329186e-2,15.20127838430069,6.453361916059307,17.240509410740277,-1.6100849625101,-11.793314463331654,15.094099378622051,-15.119342885628887,-17.06949511041297,-8.330918521014445,19.01523677435592,14.115543633643224,-8.479313679067934,4.083703217825562,17.61453451803489,-15.049483513527605,-10.609849795212249,-8.616805000546186,25.54052184093723,-11.890942115748478,-0.7844619098276022,12.86311090846822,-12.578937544277045,13.00237807067557,-9.599306230278533,13.76231546481603,-17.408884966259226,-8.548287205593196,-15.224524816425038,9.025672828835201,6.580363198390907,-8.325289747734214,-19.734013283455212,9.5163644254318,15.100534250648861,9.433626498728898,-9.816901559538808,-16.419584505814314,-10.288334659914545,7.317839798198111,15.538397350403445,-5.785332367760545,6.813852129850639,-12.17517442776904,-1.8258009829380288,6.164846582270827,9.64093268960077,-21.481292732264738,10.92012233342947,-12.233204498456892,-17.10808795243387,14.166442160364438,-4.087020120787994,6.709422294206474,18.733618607862077,-7.00789983960715,16.428693604111096,-9.97504154363192,-10.009999250562492,17.040234774153838,21.61370172459456,-18.64316232193298,0.9632717884405881,-9.553997205660975,-14.817100185742783,10.140699184941726,-17.580499753635383,-10.315412014775333,-13.982938148550717,-10.070974807129938,10.471751791450256,-13.404587022651766,13.696563463201143,13.032983849749659,11.017719047006526,9.186799344086378,7.3705337923979615,14.445975848668855,-9.763253480802206,13.339548334030106,11.344240043802557,-15.943059265325239,17.348225396541345,17.20289229990728,-13.562561281943669,-13.335173911041458,-10.926781412418592,-7.0290954474478795,-4.42601627214871,-13.120208820274021,11.89474937044515,14.109998265360003,14.233196916180653,-7.9246962172452164,-7.107967703952899,17.991104777971035,11.832212088452755,-12.052412620734959,6.409021981852029,7.784516357158173,15.140268137041579,18.62354283082552,4.487366690301931,-14.263431878609458,5.306689793957883,-7.578878635763907,-15.428620973730979,14.073874445193281,16.693189223582724,-16.992420424132956,15.651315652618795,17.788568477911042,-7.460181931312408,-11.332891083485581,8.751421309295031,6.529726411739338,2.5643180416348725,-11.263614103175717,15.798155847239139,17.557875599876215,9.751047014291617,15.209430148455933,7.9776973430942375,-8.387608724191415,-12.807851783498934,10.041158227413693,-10.861182909261347,6.0089207172283235e-2,15.338776377117675,-15.032182712158493,14.5976653539348,-8.460847903522353,9.392465895043369,16.17229348161505,8.203932065194039,-8.785879394974186,14.424657901783457,-8.419089121735265,12.692246401559007,-12.606035854090772,14.732847891893849,-16.950127291275223,5.286549895339861,12.221791785173156,5.238851014863317,14.37226918723876,-9.288257179373478,13.000521954069253,-24.03804423188166,3.050346669873831,-15.80725169710362,-13.90847598312208,-9.225317835249063,10.360403967389045,-15.66174610420767,-6.909779321304658,19.417755279769597,7.787060173209738,12.230159055623687,-10.973959329915266,-15.55275631906845,-12.28659742337774,-15.990171178814126,-14.30415097036634,16.509546396578855,13.30489762212741,-19.847456281450523,-2.4956388737113593,-11.15073509441667,2.8860072264180494,14.858845962681709,9.583256447109587,19.54429319289415,-15.80470425361907,7.795093815073185,-13.219256420057334,10.927307661123885,-13.417424695459559,16.096118431286108,-3.481540056058819,-14.20731750096403,-8.240973077227409,7.091668282186814,-12.709246022022027,-22.966510510114784,-9.417549145621459,-11.794593146983523,9.978444103956555,-8.502793512545068,3.0872867991606974,9.663647040335395,-2.7076888928857548,1.645764436006686,-5.507490656016639,-8.500370161203849,23.185321253620412,7.92809085150378,-9.831470848062082,11.507900903573715,-15.17955294199558,-5.111366372240731,-5.955222537117763,9.793768097020614,-3.4188775439617642,-15.580039607662846,-11.123155781774289,-13.332186551561955,-8.01963477528501,13.615357218564286,7.241014809093544,4.112088810279557,-9.063424317746517,0.7770438802777249,-12.189082233204086,13.063404002491279,16.679590962713924,-20.229197767022054,-5.105319826710589,-10.174206049240903,2.0876017674142195,-12.392477467267545,-17.274920532719126,-11.867863903441458,-18.657533226905468,7.438991842813834,6.38242558538509,9.01323277946895,-19.66527822700265,-9.073915755336765,-13.50197625447342,-12.533851161532585,11.36858113496153,-13.0462514259183,-10.59812169765976,13.109288063834883,-12.969314852171427,-11.189802701536776,-12.109415253085395,20.10175484545365,-12.539748044840579,-12.180634411950788,9.349549300552399,-22.42079993972809,15.853199376753965,8.525551998787845,14.0740110240772,0.906838562391082,-16.40618515032016,12.74025433921801,10.876811106830251,-8.957313085418534,-9.763165341536084,-9.76303088731529,10.422732627385107,-0.20794354947383742,5.261823550809874,-10.390416251296198,5.339494754893305,-5.065410596661976,-12.773898699081997,20.727584152627642,-7.816518017663514,15.842428766538953,-16.220794325964633,9.25917639354402,18.38916686556443,12.416670738990543,-9.66937717814335,-12.702774577833397,-13.17462858516582,-18.075177839119817,-5.735574293582161,-10.75411325160001,1.436180817699526,-15.273047871424554,-14.933296402204846,6.783385222323918,13.248914150394853,-14.63332125597324,-14.71975248917558,-14.33413215735656,-4.0513906964859485,-18.391528706759328,5.349690546995799,-13.711479938598053,11.224956820271135,3.039769120686403,-16.260961936081124,10.293596881702701,14.325311898131593,5.007918740693049,5.395508052855502,7.961798211398798,11.821440398519043,-12.439044542445467,10.498411739271129,3.3300850276342233,10.111173087219697,0.9718824362839457,-6.345188380086136,5.839355550286616,-9.248215182702506,-13.366919524825299,9.460127368952913,-10.304937953264844,-9.158651344875167,9.777186163556893,12.200809892784637,-1.3755694838291859,-20.154044599592247,-18.782714501586895,11.447150948870163,-13.876768211214875,-11.77465620871783,-7.152261719802231,9.913156583768211,1.3073319553399585,-6.2173257319682,-6.7015915370492145,14.246452141460775,-5.5645593302489695,-16.625182736093862,-7.673984535970544,6.179007130560877,-11.689816483308723,16.37172332814441,-21.05663741611937,-8.23864203434072,-10.392193025409068,14.52985226404874,-18.786493970076815,-24.600205465569246,-13.976958649916138,-8.521885209616801,15.93846922622193,7.703206379646389,17.582626057643086,-6.172932507465439,-10.086559375853604,-12.449696378393032,-12.240790872566052,1.9992708744198158,8.771088104997837,15.205242308444625,11.453021473035381,-13.728150799760224,-21.457234333684074,-10.345894255669435,8.852051323031946,9.505806368270038,-13.77720076047486,7.202498254806285,9.562458213981355,-5.855647368303073,9.431245743506047,-18.15208414501232,-5.416590166070509,-6.528906611806391,12.778785037949355,-9.425406535660915,-17.60382742622681,-6.428576638940241,10.28044104994157,11.241533036788573,-14.246654593055974,10.462730021312776,-16.371138931746923,11.215485096368923,8.863257247208113,4.5782471099387184e-2,-9.79767197923469,-6.3726083489466,8.240046105973311,8.589080996834605,-15.521683958759066,-12.452099278867312,7.638660545663033,7.1880185566299515,11.177445335472882,7.6224360689524655,-11.768079337879474,9.540037875326853,-3.2425675434448857,6.429783122978471,9.642767207401523,12.140651010462454,8.931665111134166,14.345902317714952,-10.56925158820323,-13.824009307726321,-9.357135325728676,-15.701089740206731,-11.93273595772209,17.448478994568447,8.195169345048955,-22.765713467647323,14.209407211137165,6.9297632116661365,13.974508867973746,-6.5910871558219295,-8.395181302398353,-4.312501313641433,-21.891110470158765,13.345224051594741,-13.904390818077452,13.247169692200922,-30.235444899099374,5.379241166169947,14.089906561090219,-0.455777145189958,-8.496025617365637,-4.2944515039802535,-6.966416463068525,-10.20724809491039,-11.14339148790162,-5.2488006427379785,-4.814539256074641,17.07536613840158,-17.51352470094774,8.333858714823071,13.828006549107414,-16.876974513159603,-4.944195171214916,-17.65991351748275,-11.376536366731473,18.805718498318026,9.010926046458403,4.168615920567585,20.338571618680866,-15.399763154013304,19.333942294935657,8.66804822216319,5.907827458447235,8.504499944935402,12.56265378860181,12.134333501156513,-11.157702455439942,8.919434477415574,10.670583987594211,6.363383969106269,12.935659555193064,-8.209332163166426,12.806473382164347,5.1409991372662445,-7.9668209745919025,9.111327438932447,-8.715010791750732,4.464282959199514,14.525746312068659,-16.470364183652766,-3.737698775870157,11.020222124968624,14.275381394141132,10.65513388836631,13.33064747635056,12.165014857373611,18.543101665232612,-13.734863828685507,13.022250679955569,-19.898585524476424,5.682989167724859,-8.41096325858889,-5.97810294143665,10.254754170752353,-5.9135408049183775,15.055859361491578,-6.914078221466966,14.0123947064493,22.918043597484,14.948526303571358,-18.021907236284004,14.895776108651036,-12.788643541886696,-11.839805356895194,8.744348323684964,11.645042245497237,-9.859854696909716,5.109430794714412,-12.24417540067359,10.271076880822932,-9.811959599752782,8.308441675589638,-2.130930128640103,-11.177395615266601,16.62540419262076,15.407905007779759,9.389055577948389,12.947132799257425,-9.064608835315573,-14.181819417499502,-13.250828407633717,-4.117789854495616,9.588074952359767,-12.544129476933035,7.653486971245303,-16.541716770307634,-21.027990916312085,-15.4236979251151,10.564266089120144,-2.187499995812084,-9.55252301987282,10.8820325836611,4.951064984453133,-5.63572058527179,4.194905957069816,18.35532139702979,-6.2958025625241145,19.15898050117451,11.185674217011389,7.636399501534563,19.4029768557645,4.861959360202617,19.300553760733848,-10.138925202763685,12.167929626429606,10.248920175060096,-18.235539024847842,19.664814217777856,-9.925932456411735,-6.784603741913424,-10.493860923095491,7.734541798808629,-16.776102272999008,13.304382891703312,8.168534907896586,9.397452417231785,-16.623566443505613,-8.958851643935363,13.914955227142384,8.296384529165714,8.934176264479005,-8.455729086173468,15.98512886770274,-13.36379613500281,8.508533172488109,-14.001713266371329,-12.213928921269652,17.689270352373956,-17.404440363557928,-11.948643127484559,-11.459187911490982,-8.108341590992806,-13.378322289982021,-13.463089868777423,-5.1802622741583075,2.5255873453922857,15.689892301075586,4.723606575766828,10.105176601654245,-18.35919517531285,9.246057008025856,9.271295594482439,16.202815525520755,8.894381991398879,-5.539909817146068,11.471197486952079,15.553341715778025,-12.004892929084118,14.377910589810423,-7.730602247139461,-18.125549716830598,-16.0582606844408,-5.024813233825336,15.278748576007933,-10.47876093941491,-15.54579654191344,-6.57839480761875,15.903370490884244,7.6101601501909,-12.808481931027496,-10.451251852499093,9.311419413832274,15.735852673157524,18.64306452402806,11.399700259856843,15.294440371787552,-13.978767131580213,16.924841224672942,-9.058684886420695,18.207635968812838,12.946925429928031,-9.148576331000058,11.682711021027515,13.10492851612687,-15.040835075352168,10.746787472862511,12.116043844074223,15.494946380429884,-9.728399331466592,-7.655820568543327,18.18154229518539,8.5680427959267,9.592954512719297,-10.243629224539443,-12.416032329031934,-9.371021253378878,12.888119236121215,-10.881026923084105,4.276262830081906,-15.485554496346047,-7.142818092096154,6.841831659015274,-8.612075078903507,14.625223679927352,-8.766104884456853,-4.017800077407664,-14.688473765454084,17.2843272231906,8.141425413488522,22.363278416281993,-20.382919344891487,-16.534616995815206,8.633560806180903,13.000994141141964,-7.144909785628781,-15.200236494077508,19.167962472058793,13.630311636039254,13.155615132790944,-16.76086471982221,15.342731755288641,-9.859219624097642,13.723207040151408,-7.85575778451453,13.231413685053461,14.805681135573982,-14.492509264279558,14.934790901633118,-16.480936623738252,-9.396677447061416,-13.242771724927831,18.0724826485316,16.388895219228964,6.876272357639627,13.371617735944975,-20.271486119922905,10.691243279474975,-15.511660674980035,8.63225564804407,7.352934260882126,9.700717254469225,13.063823414724965,-18.530680439000896,4.748576427486063,-12.96713183195485,13.225725264558397,-6.569888117152823,2.9670144482586833,-14.014943752153117,-10.095782858784176,-11.956893610982355,3.655312743081108,-12.086947133039958,9.66064050368915,12.446856465286283,-5.923865752520564,-15.373514554490967,9.261827402859195,8.742370219632559,13.379262617972085,13.798684657394977,11.059932973120455,-15.454022821852355,-13.169945927087129,-9.045603636805353,-14.391732455210084,-9.455669706170099,-18.502141341688667,5.832284312647682,14.990821631507238,-3.5890394750938497,-16.13244740230796,-12.584407977740186,-11.324450788345745,-16.506925354286164,11.36220981494255,-9.229818691712405,10.8465525853772,-13.893389557965419,-22.35088561573444,-7.57015426898568,22.52832271195923,12.389145353139885,-10.735455996852574,-21.005755953570734,12.380426223018917,4.792672987265234,7.909907361991592,-1.5744197364980992,8.243614624382019,-17.269503464139063,-17.961948507332306,17.38100058565345,11.547544585719537,19.33659658124312,-12.305303753346697,-12.395079843373242,-17.875968245585565,3.356286176128152,-11.792256788220438,-11.02947767214352,-13.629354306285702,-14.498013864370117,11.822547995047763,10.77911270873311,-1.6939601073850783,6.734194715234003,-18.070067349284837,-9.025883358029846,-12.048622998653737,17.542909987968155,9.452890188245462,-12.845301962092025,5.982540412367856,-13.866637862056043,5.391247848800946,11.628450807115845,-12.385689894152742,11.336369453748896,-10.747284541142712,13.720600602705131,4.429270743322391,7.849928604037754,12.030156967035749,-14.879624589711103,-16.860821376801844,-9.395762869126253,7.058458229710488,-12.082492764180454,-13.413844312393424,14.043196362179982,-1.902054169863459,-11.808493850024892,-15.143615545351256,14.60150165376723,12.581637785352521,-8.741045703588336,10.07031480043701,-8.273077934930898,-9.94930501353424,-11.567739309966337,-7.220145376137017,14.542509253680096,-14.228716309693784,-9.507715647426613,22.582985663448735,15.00016209278285,15.897238163794805,15.683435816771084,13.884883381290106,-13.686320999634473,11.85506054797404,-14.41210525757613,15.880957251085379,10.909853902606988,-17.190473518176564,-10.238411346873699,-16.165729468402787,-15.729779658680094,-15.619793674954009,-1.2301978247093188,-5.934289395292794,8.060825135339929,20.55669659632292,8.790487466754932,-17.327359680042225,6.94966711936655,-13.160238063684945,-4.770682178113522,6.916893517270782,-11.841980751877239,-20.3152273937243,-12.966280920098308,-5.932037769668446,-0.5482519886256556,17.646246950860103,7.953518406236646,-10.898092002830602,2.780482164002959,-12.39366273973831,11.349138634723854,3.0262607266270622,12.50629142009214,-6.13441741940447,-12.949655505690576,-14.151604463158577,-11.543958625518972,-15.678086515781677,6.434701183801904,-17.504953907043035,-18.200380227811895,2.881737796486745,10.103068308085549,4.047215449482366,18.997147975427968,8.194839216632197,9.541862561615346,-5.107024274795877,-12.2836249026552,12.996416993471945,9.6929486832208,-15.219603668371283,12.626233068028029,-18.514184938594024,7.908071091703866,-11.623807603684181,9.130508774344367,-14.478901448113668,-19.62692479622125,16.024384780907145,-7.065735996359958,-6.947466727908212,-7.732772742074124,1.6172089992458591,8.061624752363583,11.49684912636707,5.834276845907549,17.663871572805437,-6.382838635050382,15.44179903742323,17.43573184377312,-14.965427933809368,-11.889263623903343,-25.18064753115927,-7.569179702919483,21.407638774749472,11.268659718361787,-9.845582622278574,-17.432464059537093,14.783934848128153,6.237684214060952,-11.100340613990618,18.16265860014636,13.44506084833438,14.235471012782167,12.218120247365894,-7.8652384661106325,-11.568115993944675,-13.43003338139914,13.61544445580549,-5.232115483843246,-4.2487627103043355,12.23434657316815,16.382208103921286,-19.312548008899217,-14.673555655886574,-1.3649742189711658,-15.539013267575616,-13.000596088773044,7.616167810753549,-11.8228365867737,13.40281979893007,-12.106295644461769,-17.08672591295455,-17.27681851355516,-21.669039204528154,-17.114640926431978,-11.413587823286983,15.816206391597115,4.703386791573512,-17.411406181609987,4.672918275407155e-2,9.717859994202811,19.696170122675824,-8.741972623272579,-13.029073601592264,4.908995311926966,8.715122819970592,10.95436270562333,10.109986132735518,-21.67698209533651,9.436668877818917,5.237806382004676,8.453843534478745,-10.084771048876432,7.436102002429671,8.577348271901437,0.3049545701003124,12.853332276328523,-16.413789464660393,15.302158171660663,-14.075007517729897,-15.356863900573286,-11.21787198793231,-6.933633051979474,-15.183672306019748,-5.771512740870264,13.007846952793894,7.064003249154173,20.776005038621914,-8.30792803597604,5.923004649797669,6.212379350707593,14.507889262723612,-14.541770970786798,-18.29956001725308,10.35540545133954,17.875183248294064,9.649516230749345,-13.577013881142085,11.27354940209106,-0.7327604231331151,-7.838931783312564,-21.600038724956878,15.077952197761102,9.103654294628639,-6.486798109022443,-20.023684373295385,10.127025768207487,2.793398928361991,-3.564209135426983,-9.309339663592894,10.202080052180676,15.18854223077378,14.602351464758147]

debug_ldpc :: Int -> M Bit -> V Double -> IO (V Bit)
debug_ldpc maxIterations a orig_lam = do
  let orig_ne :: M Double
      orig_ne = fmap (const 0) a

  -- force it
  let orig_lam = V.fromList lam0

  let loop :: Int -> M Double -> V Double -> IO (V Double)
      loop !n ne lam = do
        putStrLn $ take 72 $ cycle "-"
        putStrLn $ "loop, n = " ++ show n
        putStrLn $ "ne = "
        putStrLn $ show $ [ ne ! (m,n) | m <- [1..nrows ne], n <- [1..ncols ne], a !(m,n) == 1 ]
        putStrLn $ "lam = "
        putStrLn $ show $ V.toList lam

        let c_hat :: V Bit
            c_hat = fmap hard lam

        putStrLn $ "c_hat = "
        putStrLn $ show $ V.toList $ c_hat

        let ans :: V Bit
            ans = getCol 1 (a `multStd` colVector c_hat)

        putStrLn $ "ans = "
        putStrLn $ show $ V.toList $ ans

        case () of
          _ | V.all (== 0) ans             -> do
                  putStrLn $ "success!"
                  return lam
            | n >= maxIterations           -> do
                  putStrLn $ "giving up at n = " ++ show n ++ ", returning orig_lam"
                  return orig_lam
            | otherwise                    -> do
                let ne' :: M Double
                    ne' = matrix (nrows orig_ne) (ncols orig_ne) $ \ (m,n) ->
                        if a ! (m,n) == 1
                        then
                            -2 * atanh' (product
                                [ tanh (- ((lam V.! (j-1) - ne ! (m,j)) / 2))
                                | j <- [1 .. V.length orig_lam]
                                , j /= n
                                , a ! (m,j) == 1
                                ])
                        else 0

                let neX :: [String]
                    neX = [ "-2 * atanh (product" ++ show
                                [ tanh (- ((lam V.! (j-1) - ne ! (m,j)) / 2))
                                | j <- [1 .. V.length orig_lam]
                                , j /= n
                                , a ! (m,j) == 1
                                ] ++ show
                                [ "tanh" ++ show (- ((lam V.! (j-1) - ne ! (m,j)) / 2))
                                | j <- [1 .. V.length orig_lam]
                                , j /= n
                                , a ! (m,j) == 1
                                ] ++ ""
                           | m <- [1..nrows orig_ne], n <- [1..ncols orig_ne]
                           , a ! (m,n) == 1 && isInfinite (ne' ! (m,n)) ]
                putStrLn "neX"
                print neX

                -- Was bug here: needed to add the orig_lam
                let lam' :: V Double
                    lam' = V.fromList [ V.foldr (+) (orig_lam V.! (j - 1)) (getCol j ne')
                                      | j <- [1 .. V.length lam]
                                      ]
                loop (n+1) ne' lam'

  res <- loop 0 orig_ne orig_lam
  return $ fmap hard res


-- Prelude> atanh (0.99999999999999994)
-- 18.714973875118524
-- Prelude> atanh (0.99999999999999995)
-- Infinity

-- So we cap atanh at -18.714973875118524.

atanh' :: Double -> Double
atanh' x | isInfinite y = signum x * 18.714973875118524
         | otherwise    = y
 where y = atanh x


crash = do
        h <- readAlist ("codes/moon.7.13.H")
        return $ ldpc 128 h v0

v0 = V.fromList $ [10.31704008699972,-5.762379657732054,10.71923587403389,8.69474407787769,12.403269631011147,-4.8140434138889425,1.096112697392211,-7.578778502331838,5.607400012378008,-7.687307594577467e-2,12.161984232264581,10.392572265154772,-5.1354846290270215,6.046205353391934,10.257982632106899,15.459395584777264,-5.998393431786397,12.594442761269947,1.387024485274938,5.832772771282147]
